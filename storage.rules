rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Les fichiers sont stockés par UID pour un contrôle d'accès simple
    match /uploads/{uid}/{fileName} {

      // Seul le propriétaire peut lire ou supprimer ses propres fichiers.
      // Pas de contraintes sur le type ou la taille pour la lecture/suppression.
      allow read, delete: if request.auth != null && request.auth.uid == uid;

      // Un utilisateur peut écrire un fichier dans son propre dossier si :
      // 1. Il est authentifié et son UID correspond.
      // 2. La taille du fichier est inférieure à 10 Mo.
      // 3. Le type de contenu est une image (image/*) OU l'extension du fichier correspond à une image.
      //    Cette double vérification (ceinture et bretelles) gère les cas où le navigateur
      //    ne fournit pas un type MIME correct.
      allow write: if request.auth != null
        && request.auth.uid == uid
        && request.resource.size < 10 * 1024 * 1024
        && (
          request.resource.contentType.matches('^image/.*')
          ||
          request.resource.name.matches('^uploads/' + uid + '/.*\\.(png|jpe?g|gif|webp|avif|heic|heif|svg)$')
        );
    }
  }
}
